import { visit } from 'unist-util-visit';
import { remove } from 'unist-util-remove';
import { h } from 'hastscript';
const SelfClosingHTMLElementsMap = new Map([
    ["area", true],
    ["base", true],
    ["br", true],
    ["col", true],
    ["command", true],
    ["embed", true],
    ["hr", true],
    ["img", true],
    ["input", true],
    ["keygen", true],
    ["link", true],
    ["meta", true],
    ["param", true],
    ["source", true],
    ["track", true],
    ["wbr", true]
]);
function ElementsCleanupTransformer(ast) {
    visit(ast, 'element', Visitor);
    function Visitor(node, index, parent) {
        // Remove the p tags that only contains a line-breaker
        // these p tags are mostly generated by mistakes, they won't show up on the page, thus won't affect actual editing.
        if (node.tagName === 'p' && node.children.length === 1) {
            const onlyChild = node.children[0];
            if (onlyChild.type === 'text' && onlyChild.value.trim() === "") {
                remove(parent, node);
            }
        }
        const bChildNodeInvalid = !node.children.length || (node.children.length === 1 && String(node.children[0].value).trim() === "");
        if (node.type.toLowerCase() === "element" && !SelfClosingHTMLElementsMap.get(node.tagName) && bChildNodeInvalid) {
            // special handling for list elements and pre block,
            // otherwise those elements will be hard to create
            if (node.tagName === 'li' || (node.tagName === 'code' && parent.tagName === 'pre')) {
                const mockupElement = h("span", "\u00A0");
                node.children && node.children.push(...mockupElement.children);
                return node;
            }
            else {
                remove(parent, node);
            }
        }
        return node;
    }
}
export const CleanupEmptyElements = () => ElementsCleanupTransformer;
